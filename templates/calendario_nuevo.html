<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Citas</title>
    <link rel="stylesheet" href="../static/css/styles.css">
    <link rel="stylesheet" href="../static/css/calendario.css">
    <link rel="stylesheet" href="../static/css/adicional.css">
    <link rel="stylesheet" href="../static/css/calendario_recuadro.css">
    <link rel="stylesheet" href="../static/css/calendario_mensual.css">
    <style>
        /* Estilos para el modal de detalles de cita */
        .detalle-cita {
            margin: 20px 0;
        }
        .detalle-grupo {
            margin-bottom: 10px;
            display: flex;
        }
        .detalle-label {
            font-weight: bold;
            width: 100px;
            display: inline-block;
        }
        .detalle-valor {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Calendario de Citas</h1>
            <!-- Nombre del calendario específico -->
            <h2 id="calendarioNombre">
                {% if calendarios and calendarios|length > 0 %}
                    {{ calendarios[0].nombre_calendario }}
                {% else %}
                    Sin calendario seleccionado
                {% endif %}
            </h2>
            <div class="header-controls">
                <div class="left-controls">
                    <button class="header-btn volver-btn" onclick="volverAlFormulario()">Volver al formulario</button>
                    <div class="dropdown">
                        <button class="header-btn export-btn" onclick="toggleExportMenu()">Exportar Calendario</button>
                        <div id="exportMenu" class="dropdown-content">
                            <a href="#" onclick="exportarCalendario('pdf')">Exportar a PDF</a>
                            <a href="#" onclick="exportarCalendario('excel')">Exportar a Excel</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Filtro de procedimientos -->
            {% if calendarios and calendarios|length > 1 %}
            <div class="filtro-container">
                <label for="filtroProcedimiento">Filtrar por Examen:</label>
                <select id="filtroProcedimiento" onchange="filtrarPorProcedimiento()">
                    <option value="todos">Todos los Examenes</option>
                    {% for calendario in calendarios %}
                        <option value="{{ calendario.procedimiento }}">{{ calendario.procedimiento }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </header>

        <!-- Contenido del calendario -->
        <div class="calendar calendar-recuadro">
            <div class="calendario-header">
                <div class="calendario-info">
                    <div class="info-item">
                        <span class="info-label">Total:</span> <span id="totalCitas" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Confirmadas:</span> <span id="citasConfirmadas" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Reservadas:</span> <span id="citasReservadas" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Disponibles:</span> <span id="slotsDisponibles" class="info-value">0</span>
                    </div>
                </div>
            </div>

            <!-- Controles de navegación del mes y cambio de vista -->
            <div class="mes-navegacion">
                <div class="nav-izquierda">
                    <button id="mesAnterior" class="btn-nav">&laquo; Mes Anterior</button>
                    <h3 id="mesActual" class="titulo-mes">Mes Actual</h3>
                    <button id="mesSiguiente" class="btn-nav">Mes Siguiente &raquo;</button>
                </div>
                <div class="nav-derecha">
                    <button id="btnVistaMensual" class="btn-vista active" onclick="cambiarVistaCalendario('mensual')">Vista Mensual</button>
                    <button id="btnVistaDetallada" class="btn-vista" onclick="cambiarVistaCalendario('detallado')">Vista Detallada</button>
                </div>
            </div>

            <!-- Contenedor para el calendario mensual -->
            <div id="calendarioMensual" class="calendario-mensual">
                <div class="dias-semana">
                    <div>Lun</div>
                    <div>Mar</div>
                    <div>Mié</div>
                    <div>Jue</div>
                    <div>Vie</div>
                    <div>Sáb</div>
                    <div>Dom</div>
                </div>
                <div id="diasMes" class="dias-mes">
                    <!-- Aquí se generarán los días del mes -->
                </div>
            </div>

            <!-- Contenedor para la cuadrícula del calendario (vista detallada) -->
            <div id="calendarioGrid" class="calendario-grid-recuadro" style="display: none;">
                <!-- Aquí se generará la estructura del calendario en formato de recuadro -->
            </div>
        </div>
    </div>

    <!-- Leyenda para estados de citas -->
    <footer class="calendario-leyenda">
        <h3>Estados de Citas</h3>

        <div class="leyenda-item">
            <div class="color-box disponible"></div>
            <span>Disponible</span>
        </div>
        <div class="leyenda-item">
            <div class="color-box ocupado-temp"></div>
            <span>Ocupado Momentáneamente</span>
        </div>
        <div class="leyenda-item">
            <div class="color-box ocupado"></div>
            <span>Ocupado</span>
        </div>
        <div class="leyenda-item">
            <div class="color-box descanso"></div>
            <span>Tiempo de Descanso</span>
        </div>
        <div class="leyenda-item">
            <div class="color-box tiempo-fuera"></div>
            <span>Tiempo Fuera</span>
        </div>
    </footer>

    <!-- Modal para agendar cita -->
    <div id="agendarCitaModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Agendar Cita</h2>
            <form id="formAgendarCita">
                <input type="hidden" id="agendarHora" name="hora">
                <input type="hidden" id="agendarDia" name="dia">
                <div class="form-group">
                    <label for="nombrePaciente">Nombre del Paciente:</label>
                    <input type="text" id="nombrePaciente" name="nombrePaciente" required>
                </div>
                <div class="form-group">
                    <label for="documentoPaciente">Documento:</label>
                    <input type="text" id="documentoPaciente" name="documentoPaciente" required>
                </div>
                <div class="form-group">
                    <label for="telefonoPaciente">Teléfono:</label>
                    <input type="tel" id="telefonoPaciente" name="telefonoPaciente" required>
                </div>
                <div class="form-group">
                    <label for="examenesPaciente">Examen:</label>
                    <select id="examenesPaciente" name="examenesPaciente" required>
                        <option value="">Seleccione un examen</option>
                        <!-- Opciones de exámenes se cargarán dinámicamente -->
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Agendar</button>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('agendarCitaModal').style.display='none'">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para mostrar detalles de cita -->
    <div id="detalleCitaModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('detalleCitaModal').style.display='none'">&times;</span>
            <h2>Detalles de la Cita</h2>
            <input type="hidden" id="detalleCitaId">
            <div class="detalle-cita">
                <div class="detalle-grupo">
                    <span class="detalle-label">Paciente:</span>
                    <span id="detallePaciente" class="detalle-valor"></span>
                </div>
                <div class="detalle-grupo">
                    <span class="detalle-label">Documento:</span>
                    <span id="detalleDocumento" class="detalle-valor"></span>
                </div>
                <div class="detalle-grupo">
                    <span class="detalle-label">Teléfono:</span>
                    <span id="detalleTelefono" class="detalle-valor"></span>
                </div>
                <div class="detalle-grupo">
                    <span class="detalle-label">Examen:</span>
                    <span id="detalleExamen" class="detalle-valor"></span>
                </div>
                <div class="detalle-grupo">
                    <span class="detalle-label">Fecha:</span>
                    <span id="detalleFecha" class="detalle-valor"></span>
                </div>
                <div class="detalle-grupo">
                    <span class="detalle-label">Hora:</span>
                    <span id="detalleHora" class="detalle-valor"></span>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="document.getElementById('detalleCitaModal').style.display='none'">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Función para volver al formulario
        function volverAlFormulario() {
            window.location.href = "/form";
        }

        // Función para mostrar/ocultar el menú de exportación
        function toggleExportMenu() {
            document.getElementById("exportMenu").classList.toggle("show");
        }

        // Cerrar el menú de exportación si se hace clic fuera de él
        window.onclick = function(event) {
            if (!event.target.matches('.export-btn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Función para exportar el calendario
        function exportarCalendario(formato) {
            alert("Exportando calendario a " + formato);
            // Implementar la lógica de exportación según el formato
        }

        // Pasar los datos del calendario al JavaScript
        {% if calendarios and calendarios|length > 0 %}
        const calendarioData = {
            nombreCalendario: "{{ calendarios[0].nombre_calendario }}",
            municipio: "{{ calendarios[0].municipio }}",
            procedimiento: "{{ calendarios[0].procedimiento }}",
            fechaInicio: "{{ calendarios[0].fecha_inicio }}",
            fechaFin: "{{ calendarios[0].fecha_fin }}",
            horaInicio: "{{ calendarios[0].hora_inicio }}",
            horaFin: "{{ calendarios[0].hora_fin }}",
            espacioCitas: "{{ calendarios[0].espacio_citas }}",
            tiempoFuera: "{{ calendarios[0].tiempo_fuera }}",
            inicioHoraDescanso: "{{ calendarios[0].inicio_hora_descanso or '' }}",
            finHoraDescanso: "{{ calendarios[0].fin_hora_descanso or '' }}",
            id: "{{ calendarios[0].id }}"
        };
        
        // Pasar las citas al JavaScript
        const citasData = [
            {% for cita in citas %}
            {
                id: "{{ cita.id }}",
                fecha: "{{ cita.fecha }}",
                hora: "{{ cita.hora }}",
                estado: "{{ cita.estado }}"
                {% if cita.paciente %},
                paciente: "{{ cita.paciente }}",
                documento: "{{ cita.documento }}",
                telefono: "{{ cita.telefono }}",
                examen: "{{ cita.examen }}"
                {% endif %}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        console.log("Datos del Calendario:", calendarioData);
        // Guardar en localStorage para uso posterior
        localStorage.setItem('configuracionCalendario', JSON.stringify(calendarioData));
        {% endif %}

        // Función para mostrar los detalles de una cita
        function mostrarDetalleCita(citaId) {
            // Buscar la cita por su ID
            const cita = citasData.find(c => c.id === citaId);
            
            if (!cita) {
                console.error("No se encontró la cita con ID:", citaId);
                return;
            }
            
            // Llenar el modal con los detalles de la cita
            document.getElementById('detalleCitaId').value = cita.id;
            document.getElementById('detallePaciente').textContent = cita.paciente || 'No disponible';
            document.getElementById('detalleDocumento').textContent = cita.documento || 'No disponible';
            document.getElementById('detalleTelefono').textContent = cita.telefono || 'No disponible';
            document.getElementById('detalleExamen').textContent = cita.examen || 'No disponible';
            document.getElementById('detalleFecha').textContent = cita.fecha || 'No disponible';
            document.getElementById('detalleHora').textContent = cita.hora || 'No disponible';
            
            // Mostrar el modal
            document.getElementById('detalleCitaModal').style.display = 'block';
        }
        
        // Función para cambiar entre vistas de calendario
        function cambiarVistaCalendario(tipo) {
            const calendarioMensual = document.getElementById('calendarioMensual');
            const calendarioGrid = document.getElementById('calendarioGrid');
            
            if (tipo === 'mensual') {
                calendarioMensual.style.display = 'block';
                calendarioGrid.style.display = 'none';
            } else if (tipo === 'detallado') {
                calendarioMensual.style.display = 'none';
                calendarioGrid.style.display = 'block';
            }
        }
        
        // Inicialización cuando el DOM está cargado
        document.addEventListener('DOMContentLoaded', function() {
            {% if calendarios and calendarios|length > 0 %}
            // Mostrar el nombre del calendario
            const nombreCalendarioElement = document.getElementById('calendarioNombre');
            if (nombreCalendarioElement) {
                nombreCalendarioElement.textContent = calendarioData.nombreCalendario;
            }

            // Verificar y formatear las fechas
            const fechaInicioStr = calendarioData.fechaInicio;
            const fechaFinStr = calendarioData.fechaFin;

            // Validar que las fechas no sean nulas o vacías
            if (!fechaInicioStr || !fechaFinStr) {
                console.error("Fechas de inicio o fin no válidas");
                return;
            }

            // Crear objetos Date
            const fechaInicio = new Date(fechaInicioStr);
            const fechaFin = new Date(fechaFinStr);

            // Verificar si las fechas son válidas
            if (isNaN(fechaInicio) || isNaN(fechaFin)) {
                console.error("Formato de fecha no válido:", { fechaInicioStr, fechaFinStr });
                return;
            }

            console.log("Fechas válidas:", { fechaInicio, fechaFin });
            
            // Establecer el mes actual basado en la fecha de inicio del calendario
            mesActual = new Date(fechaInicio);
            
            // Mostrar información de las citas cargadas
            if (citasData && citasData.length > 0) {
                console.log("Citas cargadas:", citasData);
            } else {
                console.log("No hay citas para este calendario");
            }

            // Generar el calendario con un pequeño retraso
            setTimeout(() => {
                generarCalendario();
                // Inicializar eventos después de generar el calendario
                inicializarEventos();
                // Cargar las citas existentes en el calendario
                cargarCitasExistentes();
                // Por defecto, mostrar la vista mensual
                cambiarVistaCalendario('mensual');
            }, 500);
            {% else %}
            console.error("No hay datos de calendario disponibles");
            {% endif %}
        });
        
        // Función para cargar las citas existentes en el calendario
        function cargarCitasExistentes() {
            if (!citasData || citasData.length === 0) return;
            
            console.log("Cargando citas existentes en el calendario...");
            
            // Actualizar el calendario mensual con las citas
            generarCalendarioMensual(mesActual);
            
            // También cargar las citas en el formato de recuadro (vista detallada)
            cargarCitasEnRecuadro();
            
            // Actualizar contadores después de cargar las citas
            actualizarContadores();
        }
        
        // Función para cargar las citas en el formato de recuadro
        function cargarCitasEnRecuadro() {
            if (!citasData || citasData.length === 0) return;
            
            citasData.forEach(cita => {
                // Formatear la fecha y hora para buscar el slot correspondiente
                const fechaCita = cita.fecha;
                const horaCita = cita.hora;
                
                // Buscar el slot correspondiente a esta cita en el formato de recuadro
                const slot = document.querySelector(`.slot[data-dia="${fechaCita}"][data-hora="${horaCita}"]`);
                
                if (slot) {
                    // Marcar el slot como ocupado
                    slot.classList.remove('disponible');
                    slot.classList.add('ocupado');
                    slot.setAttribute('data-disponible', 'false');
                    slot.setAttribute('data-cita-id', cita.id);
                    
                    // Si hay información del paciente, mostrarla
                    if (cita.paciente) {
                        slot.innerHTML = `<span class="slot-text">${cita.paciente}</span>`;
                        slot.setAttribute('data-paciente', cita.paciente);
                        if (cita.documento) slot.setAttribute('data-documento', cita.documento);
                        if (cita.telefono) slot.setAttribute('data-telefono', cita.telefono);
                        if (cita.examen) slot.setAttribute('data-examen', cita.examen);
                    } else {
                        slot.innerHTML = `<span class="slot-text">Ocupado</span>`;
                    }
                    
                    console.log(`Cita cargada en recuadro: ${fechaCita} ${horaCita}`);
                }
            });
        }

        // Variables globales para el calendario mensual
        let mesActual = new Date();
        
        // Función para inicializar el calendario
        function generarCalendario() {
            console.log("Generando calendario mensual...");
            
            // Inicializar el calendario mensual
            generarCalendarioMensual(mesActual);
            
            // Configurar los botones de navegación
            document.getElementById('mesAnterior').addEventListener('click', () => {
                mesActual.setMonth(mesActual.getMonth() - 1);
                generarCalendarioMensual(mesActual);
            });
            
            document.getElementById('mesSiguiente').addEventListener('click', () => {
                mesActual.setMonth(mesActual.getMonth() + 1);
                generarCalendarioMensual(mesActual);
            });
            
            // También mantener la función para generar el calendario en formato de recuadro
            // para poder cambiar entre vistas si es necesario
            generarCalendarioRecuadro();
        }
        
        // Función para generar el calendario mensual
        function generarCalendarioMensual(fecha) {
            const diasMes = document.getElementById('diasMes');
            const tituloMes = document.getElementById('mesActual');
            
            if (!diasMes || !tituloMes) {
                console.error("No se encontraron los elementos del calendario mensual");
                return;
            }
            
            // Actualizar el título del mes
            tituloMes.textContent = fecha.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            
            // Limpiar el contenedor de días
            diasMes.innerHTML = '';
            
            // Obtener el primer día del mes
            const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1);
            
            // Obtener el último día del mes
            const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
            
            // Ajustar el primer día para que comience en lunes (1) en lugar de domingo (0)
            let diaSemana = primerDia.getDay();
            diaSemana = diaSemana === 0 ? 6 : diaSemana - 1; // Convertir domingo (0) a 6, y restar 1 al resto
            
            // Crear celdas para los días del mes anterior para completar la primera semana
            const diasMesAnterior = new Date(fecha.getFullYear(), fecha.getMonth(), 0).getDate();
            for (let i = diasMesAnterior - diaSemana + 1; i <= diasMesAnterior; i++) {
                const dia = crearCeldaDia(i, true);
                diasMes.appendChild(dia);
            }
            
            // Fecha actual para marcar el día de hoy
            const hoy = new Date();
            const esHoyMismoMes = hoy.getMonth() === fecha.getMonth() && hoy.getFullYear() === fecha.getFullYear();
            
            // Crear celdas para los días del mes actual
            for (let i = 1; i <= ultimoDia.getDate(); i++) {
                const esHoy = esHoyMismoMes && i === hoy.getDate();
                const dia = crearCeldaDia(i, false, esHoy);
                
                // Verificar si hay citas para este día
                const fechaStr = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const citasDelDia = citasData.filter(cita => cita.fecha === fechaStr);
                
                if (citasDelDia.length > 0) {
                    dia.classList.add('con-citas');
                    
                    // Agregar indicador de citas
                    const indicador = document.createElement('div');
                    indicador.className = 'indicador-citas';
                    dia.appendChild(indicador);
                    
                    // Agregar lista de citas (limitada a 3 para no sobrecargar la vista)
                    const citasContainer = document.createElement('div');
                    citasContainer.className = 'citas-dia';
                    
                    const maxCitasMostradas = Math.min(citasDelDia.length, 3);
                    for (let j = 0; j < maxCitasMostradas; j++) {
                        const citaItem = document.createElement('div');
                        citaItem.className = 'cita-item';
                        citaItem.textContent = citasDelDia[j].paciente || `Cita ${j+1}`;
                        citaItem.setAttribute('data-cita-id', citasDelDia[j].id);
                        citaItem.addEventListener('click', () => mostrarDetalleCita(citasDelDia[j].id));
                        citasContainer.appendChild(citaItem);
                    }
                    
                    // Si hay más citas de las que se muestran, agregar indicador
                    if (citasDelDia.length > maxCitasMostradas) {
                        const masCitas = document.createElement('div');
                        masCitas.className = 'cita-item mas-citas';
                        masCitas.textContent = `+ ${citasDelDia.length - maxCitasMostradas} más`;
                        citasContainer.appendChild(masCitas);
                    }
                    
                    dia.appendChild(citasContainer);
                }
                
                diasMes.appendChild(dia);
            }
            
            // Calcular cuántos días del siguiente mes necesitamos para completar la cuadrícula
            const totalCeldasActuales = diaSemana + ultimoDia.getDate();
            const celdasFaltantes = 7 - (totalCeldasActuales % 7 || 7); // Si es 0, necesitamos 7 celdas
            
            // Crear celdas para los días del mes siguiente
            for (let i = 1; i <= celdasFaltantes; i++) {
                const dia = crearCeldaDia(i, true);
                diasMes.appendChild(dia);
            }
            
            // Actualizar contadores
            actualizarContadores();
        }
        
        // Función para crear una celda de día
        function crearCeldaDia(numeroDia, esOtroMes, esHoy = false) {
            const dia = document.createElement('div');
            dia.className = 'dia';
            
            if (esOtroMes) {
                dia.classList.add('otro-mes');
            }
            
            if (esHoy) {
                dia.classList.add('hoy');
            }
            
            const numero = document.createElement('div');
            numero.className = 'numero-dia';
            numero.textContent = numeroDia;
            dia.appendChild(numero);
            
            return dia;
        }
        
        // Función para generar el calendario en formato de recuadro (vista detallada)
        function generarCalendarioRecuadro() {
            console.log("Generando calendario en formato de recuadro...");
            const calendarioGrid = document.getElementById('calendarioGrid');

            if (!calendarioGrid) {
                console.error("No se encontró el contenedor del calendario");
                return;
            }

            // Limpiar el contenedor
            calendarioGrid.innerHTML = '';

            // Crear estructura básica del calendario
            const horaInicio = calendarioData.horaInicio;
            const horaFin = calendarioData.horaFin;
            const fechaInicio = new Date(calendarioData.fechaInicio);
            const fechaFin = new Date(calendarioData.fechaFin);

            console.log("Configuración:", {horaInicio, horaFin, fechaInicio, fechaFin});

            // Extraer horas para el cálculo
            const horaInicioNum = parseInt(horaInicio.split(':')[0]);
            const minInicioNum = parseInt(horaInicio.split(':')[1]) || 0;
            const horaFinNum = parseInt(horaFin.split(':')[0]);
            const minFinNum = parseInt(horaFin.split(':')[1]) || 0;

            // Generar tarjetas para cada día
            for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
                // Verificar si el día es domingo (0 en JavaScript)
                if (d.getDay() === 0) {
                    continue; // Saltar los domingos
                }

                // Crear tarjeta para el día
                const diaCard = document.createElement('div');
                diaCard.className = 'dia-card';

                // Crear encabezado de la tarjeta
                const diaHeader = document.createElement('div');
                diaHeader.className = 'dia-header';

                const dayOfWeek = document.createElement('div');
                dayOfWeek.className = 'day-of-week';
                dayOfWeek.textContent = d.toLocaleDateString('es-ES', { weekday: 'short' }).toUpperCase();

                const dayOfMonth = document.createElement('div');
                dayOfMonth.className = 'day-of-month';
                dayOfMonth.textContent = d.getDate();

                const month = document.createElement('div');
                month.className = 'month';
                month.textContent = d.toLocaleDateString('es-ES', { month: 'short' });

                diaHeader.appendChild(dayOfWeek);
                diaHeader.appendChild(dayOfMonth);
                diaHeader.appendChild(month);

                diaCard.appendChild(diaHeader);

                // Crear contenedor para los slots de hora
                const slotsContainer = document.createElement('div');
                slotsContainer.className = 'slots-container';

                // Generar slots para cada hora
                for (let h = horaInicioNum; h < horaFinNum; h++) {
                    // Determinar si se necesitan intervalos
                    const intervaloMinutos = parseInt(calendarioData.espacioCitas) || 60;
                    const intervalosHora = 60 / intervaloMinutos;

                    // Si no hay intervalos específicos o el intervalo es de 60 minutos, crear un solo slot por hora
                    if (intervaloMinutos >= 60) {
                        // Crear slot de hora
                        const horaSlot = document.createElement('div');
                        horaSlot.className = 'hora-slot';

                        // Mostrar la hora
                        const slotTime = document.createElement('div');
                        slotTime.className = 'slot-time';
                        slotTime.textContent = `${h.toString().padStart(2, '0')}:00`;
                        horaSlot.appendChild(slotTime);

                        // Crear el slot para la cita
                        const slot = document.createElement('div');
                        slot.className = 'slot disponible';
                        slot.setAttribute('data-hora', `${h.toString().padStart(2, '0')}:00`);
                        slot.setAttribute('data-dia', d.toISOString().split('T')[0]);

                        // Verificar si es hora de descanso
                        const horaDescansoInicio = calendarioData.inicioHoraDescanso || '';
                        const horaDescansoFin = calendarioData.finHoraDescanso || '';
                        const horaActual = `${h.toString().padStart(2, '0')}:00`;

                        if (horaDescansoInicio && horaDescansoFin &&
                            horaActual >= horaDescansoInicio &&
                            horaActual < horaDescansoFin) {
                            slot.className = 'slot descanso';
                            slot.innerHTML = '<span class="slot-text">Descanso</span>';
                        } else {
                            slot.innerHTML = '<span class="slot-indicator"></span>';
                            // Agregar atributo para identificar slots disponibles
                            slot.setAttribute('data-disponible', 'true');
                        }

                        horaSlot.appendChild(slot);
                        slotsContainer.appendChild(horaSlot);
                    } else {
                        // Crear múltiples slots para intervalos menores a una hora
                        for (let m = 0; m < 60; m += intervaloMinutos) {
                            // Si es la primera hora y los minutos son menores que los minutos iniciales, saltar
                            if (h === horaInicioNum && m < minInicioNum) continue;

                            // Si es la última hora y los minutos son mayores que los minutos finales, saltar
                            if (h === horaFinNum - 1 && m >= minFinNum && minFinNum > 0) continue;

                            // Crear slot de hora
                            const horaSlot = document.createElement('div');
                            horaSlot.className = 'hora-slot';

                            // Mostrar la hora
                            const slotTime = document.createElement('div');
                            slotTime.className = 'slot-time';
                            slotTime.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                            horaSlot.appendChild(slotTime);

                            // Crear el slot para la cita
                            const slot = document.createElement('div');
                            slot.className = 'slot disponible';
                            slot.setAttribute('data-hora', `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`);
                            slot.setAttribute('data-dia', d.toISOString().split('T')[0]);

                            // Verificar si es hora de descanso
                            const horaDescansoInicio = calendarioData.inicioHoraDescanso || '';
                            const horaDescansoFin = calendarioData.finHoraDescanso || '';
                            const horaActual = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;

                            if (horaDescansoInicio && horaDescansoFin &&
                                horaActual >= horaDescansoInicio &&
                                horaActual < horaDescansoFin) {
                                slot.className = 'slot descanso';
                                slot.innerHTML = '<span class="slot-text">Descanso</span>';
                            } else {
                                slot.innerHTML = '<span class="slot-indicator"></span>';
                                // Agregar atributo para identificar slots disponibles
                                slot.setAttribute('data-disponible', 'true');
                            }

                            horaSlot.appendChild(slot);
                            slotsContainer.appendChild(horaSlot);
                        }
                    }
                }

                diaCard.appendChild(slotsContainer);
                calendarioGrid.appendChild(diaCard);
            }


            console.log("Calendario generado con éxito");

            // Actualizar contadores
            actualizarContadores();
        }

        // Función para actualizar los contadores
        function actualizarContadores() {
            // Contar citas basadas en los datos disponibles
            const totalCitas = citasData ? citasData.length : 0;
            document.getElementById('totalCitas').textContent = totalCitas;
            
            // Contar citas confirmadas (estado ocupado)
            const citasConfirmadas = citasData ? citasData.filter(cita => cita.estado === 'ocupado' || cita.paciente).length : 0;
            document.getElementById('citasConfirmadas').textContent = citasConfirmadas;
            
            // Contar citas reservadas temporalmente
            const citasReservadas = citasData ? citasData.filter(cita => cita.estado === 'ocupado-temp').length : 0;
            document.getElementById('citasReservadas').textContent = citasReservadas;
            
            // Calcular slots disponibles basados en la vista actual
            let slotsDisponibles = 0;
            
            if (document.getElementById('calendarioGrid').style.display !== 'none') {
                // En vista detallada, contar slots disponibles
                slotsDisponibles = document.querySelectorAll('.slot.disponible').length;
            } else {
                // En vista mensual, calcular slots disponibles basados en la configuración
                const fechaInicio = new Date(calendarioData.fechaInicio);
                const fechaFin = new Date(calendarioData.fechaFin);
                const horaInicioNum = parseInt(calendarioData.horaInicio.split(':')[0]);
                const horaFinNum = parseInt(calendarioData.horaFin.split(':')[0]);
                const intervaloMinutos = parseInt(calendarioData.espacioCitas) || 60;
                
                // Calcular días laborables (excluyendo domingos)
                let diasLaborables = 0;
                for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
                    if (d.getDay() !== 0) { // 0 es domingo
                        diasLaborables++;
                    }
                }
                
                // Calcular slots por día
                const horasPorDia = horaFinNum - horaInicioNum;
                const slotsPorDia = horasPorDia * (60 / intervaloMinutos);
                
                // Total de slots posibles
                const totalSlotsPosibles = diasLaborables * slotsPorDia;
                
                // Slots disponibles = total posibles - ocupados - reservados - descansos
                slotsDisponibles = totalSlotsPosibles - citasConfirmadas - citasReservadas;
            }
            
            document.getElementById('slotsDisponibles').textContent = slotsDisponibles > 0 ? slotsDisponibles : 0;
        }

        // Función para inicializar eventos en ambos formatos de calendario
        function inicializarEventos() {
            // Inicializar eventos para la vista de recuadro
            inicializarEventosRecuadro();
            
            // Inicializar eventos para la vista mensual
            inicializarEventosMensual();
            
            // Inicializar eventos para los botones de cambio de vista
            document.getElementById('btnVistaMensual').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('btnVistaDetallada').classList.remove('active');
                cambiarVistaCalendario('mensual');
            });
            
            document.getElementById('btnVistaDetallada').addEventListener('click', function() {
                this.classList.add('active');
                document.getElementById('btnVistaMensual').classList.remove('active');
                cambiarVistaCalendario('detallado');
            });
            
            // Cerrar modales al hacer clic en la X
            document.querySelectorAll('.close-modal').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // Cerrar modales al hacer clic fuera de ellos
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
            
            // Manejar el envío del formulario de agendar cita
            document.getElementById('formAgendarCita').addEventListener('submit', function(event) {
                event.preventDefault();
                // Aquí iría la lógica para guardar la cita
                alert('Funcionalidad de agendar cita en desarrollo');
                document.getElementById('agendarCitaModal').style.display = 'none';
                // Recargar el calendario después de agendar
                generarCalendarioMensual(mesActual);
                generarCalendarioRecuadro();
            });
        }
        
        // Función para inicializar eventos en la vista mensual
        function inicializarEventosMensual() {
            // Agregar eventos a los días del calendario mensual
            document.querySelectorAll('.dia').forEach(dia => {
                dia.addEventListener('click', function() {
                    // Si el día tiene citas, permitir ver detalles
                    if (this.classList.contains('con-citas')) {
                        // Marcar el día como seleccionado
                        document.querySelectorAll('.dia.seleccionado').forEach(d => {
                            d.classList.remove('seleccionado');
                        });
                        this.classList.add('seleccionado');
                        
                        // Si el usuario hace doble clic, cambiar a vista detallada
                        if (this._lastClick && (new Date() - this._lastClick) < 300) {
                            // Obtener la fecha del día seleccionado
                            const mes = mesActual.getMonth();
                            const anio = mesActual.getFullYear();
                            const numeroDia = parseInt(this.querySelector('.numero-dia').textContent);
                            
                            // Si es un día de otro mes, no hacer nada
                            if (this.classList.contains('otro-mes')) return;
                            
                            // Cambiar a la vista detallada
                            cambiarVistaCalendario('detallado');
                            document.getElementById('btnVistaDetallada').classList.add('active');
                            document.getElementById('btnVistaMensual').classList.remove('active');
                        }
                        this._lastClick = new Date();
                    }
                });
            });
            
            // Agregar eventos a los items de citas en el calendario mensual
            document.querySelectorAll('.cita-item').forEach(item => {
                item.addEventListener('click', function(event) {
                    event.stopPropagation(); // Evitar que el evento se propague al día
                    const citaId = this.getAttribute('data-cita-id');
                    if (citaId) {
                        mostrarDetalleCita(citaId);
                    }
                });
            });
        }
        
        // Función para inicializar eventos en la vista de recuadro
        function inicializarEventosRecuadro() {
            // Agregar evento click a todos los slots disponibles
            document.querySelectorAll('.slot.disponible').forEach(slot => {
                slot.addEventListener('click', function() {
                    // Verificar si el slot ya está ocupado
                    if (this.classList.contains('ocupado') || this.classList.contains('ocupado-temp')) return;

                    // Obtener y asignar datos correctamente
                    const hora = this.getAttribute('data-hora');
                    const dia = this.getAttribute('data-dia');

                    // Asignar valores a los campos ocultos del formulario de agendar
                    document.getElementById('agendarHora').value = hora;
                    document.getElementById('agendarDia').value = dia;

                    // Mostrar el modal de agendar cita
                    document.getElementById('agendarCitaModal').style.display = 'block';
                });
            });
            
            // Agregar evento click a los slots ocupados para mostrar información
            document.querySelectorAll('.slot.ocupado').forEach(slot => {
                slot.addEventListener('click', function() {
                    // Obtener datos del paciente
                    const paciente = this.getAttribute('data-paciente') || 'No disponible';
                    const documento = this.getAttribute('data-documento') || 'No disponible';
                    const telefono = this.getAttribute('data-telefono') || 'No disponible';
                    const examen = this.getAttribute('data-examen') || 'No disponible';
                    const hora = this.getAttribute('data-hora');
                    const dia = this.getAttribute('data-dia');
                    const citaId = this.getAttribute('data-cita-id');
                    
                    // Mostrar información en el modal de detalles
                    document.getElementById('detallePaciente').textContent = paciente;
                    document.getElementById('detalleDocumento').textContent = documento;
                    document.getElementById('detalleTelefono').textContent = telefono;
                    document.getElementById('detalleExamen').textContent = examen;
                    document.getElementById('detalleFecha').textContent = dia;
                    document.getElementById('detalleHora').textContent = hora;
                    
                    if (citaId) {
                        document.getElementById('detalleCitaId').value = citaId;
                    }
                    
                    // Mostrar el modal de detalles
                    document.getElementById('detalleCitaModal').style.display = 'block';
                });
            });

            // Cerrar modales al hacer clic en la X
            document.querySelectorAll('.close-modal').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    // Cerrar todos los modales
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Cerrar modales al hacer clic fuera del contenido
            window.addEventListener('click', function(event) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // Manejar el envío del formulario de agendar cita
            document.getElementById('formAgendarCita').addEventListener('submit', function(e) {
                e.preventDefault();
                const hora = document.getElementById('agendarHora').value;
                const dia = document.getElementById('agendarDia').value;
                const nombre = document.getElementById('nombrePaciente').value;
                const documento = document.getElementById('documentoPaciente').value;
                const telefono = document.getElementById('telefonoPaciente').value;
                const examen = document.getElementById('examenesPaciente').value;

                console.log('Agendando cita:', { hora, dia, nombre, documento, telefono, examen });

                // Crear objeto con los datos de la cita
                const citaData = {
                    calendario_id: calendarioData.id,
                    fecha: dia,
                    hora: hora,
                    paciente: nombre,
                    documento: documento,
                    telefono: telefono,
                    examen: examen
                };

                // Enviar datos al servidor mediante fetch
                fetch('/api/citas/crear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(citaData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Cita guardada:', data);
                    
                    // Actualizar la interfaz
                    const slot = document.querySelector(`.slot[data-hora="${hora}"][data-dia="${dia}"]`);
                    if (slot) {
                        slot.classList.remove('disponible');
                        slot.classList.add('ocupado');
                        slot.innerHTML = `<span class="slot-text">${nombre}</span>`;
                        slot.setAttribute('data-disponible', 'false');
                        slot.setAttribute('data-paciente', nombre);
                        slot.setAttribute('data-documento', documento);
                        slot.setAttribute('data-telefono', telefono);
                        slot.setAttribute('data-examen', examen);
                        if (data.id) {
                            slot.setAttribute('data-cita-id', data.id);
                        }
                    }
                    
                    // Cerrar el modal
                    document.getElementById('agendarCitaModal').style.display = 'none';
                    
                    // Actualizar contadores
                    actualizarContadores();
                })
                .catch(error => {
                    console.error('Error al guardar la cita:', error);
                    alert('Error al guardar la cita. Por favor, inténtelo de nuevo.');
                })

                // Actualizar contadores
                actualizarContadores();

                // Cerrar el modal
                document.getElementById('agendarCitaModal').style.display = 'none';
            });

            // Función para filtrar por procedimiento (si hay múltiples calendarios)
            if (document.getElementById('filtroProcedimiento')) {
                document.getElementById('filtroProcedimiento').addEventListener('change', function() {
                    const procedimiento = this.value;
                    console.log('Filtrando por procedimiento:', procedimiento);
                    // Implementar lógica de filtrado
                });
            }
        }

        // Función para cargar opciones de exámenes
        function cargarOpcionesExamenes() {
            const selectExamenes = document.getElementById('examenesPaciente');
            if (selectExamenes) {
                // Limpiar opciones existentes
                selectExamenes.innerHTML = '<option value="">Seleccione un examen</option>';
                
                // Agregar el procedimiento actual como opción
                if (calendarioData && calendarioData.procedimiento) {
                    const option = document.createElement('option');
                    option.value = calendarioData.procedimiento;
                    option.textContent = calendarioData.procedimiento;
                    selectExamenes.appendChild(option);
                }
            }
        }
    </script>
</body>

</html>